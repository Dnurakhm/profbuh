# Исправление дублирования уведомлений

## Проблема
При отправке сообщения приходят и одиночные уведомления (старый способ), и группированные (новый способ) одновременно.

## Причина
В базе данных работают два триггера одновременно:
1. Старый триггер - создает одиночные уведомления для каждого сообщения
2. Новый триггер - создает/обновляет группированные уведомления

## Решение

### Шаг 1: Найти все триггеры на messages

1. Откройте Supabase Dashboard → SQL Editor
2. Выполните этот запрос, чтобы увидеть все триггеры:
```sql
SELECT 
  trigger_name,
  event_manipulation,
  action_statement,
  action_timing
FROM information_schema.triggers
WHERE event_object_table = 'messages'
ORDER BY trigger_name;
```

3. Запишите имена всех триггеров (кроме `on_message_insert_notification`)

### Шаг 2: Удалить старые триггеры

1. Откройте файл `supabase_remove_old_notification_triggers.sql`
2. Если в Шаге 1 вы нашли триггеры с другими именами, добавьте их в SQL:
   ```sql
   DROP TRIGGER IF EXISTS ваше_имя_триггера ON messages;
   ```
3. Выполните весь SQL код из файла

### Шаг 3: Проверьте работу

1. Отправьте несколько сообщений в чате одного проекта
2. Проверьте уведомления - должно быть только одно группированное уведомление
3. Если все еще приходят одиночные - проверьте, нет ли других триггеров

## Альтернативное решение (если не знаете имена триггеров)

Если вы не знаете имена старых триггеров, можно временно отключить все триггеры и включить только нужный:

```sql
-- Отключаем все триггеры на messages
ALTER TABLE messages DISABLE TRIGGER ALL;

-- Включаем только наш триггер
ALTER TABLE messages ENABLE TRIGGER on_message_insert_notification;
```

**ВНИМАНИЕ:** Это отключит ВСЕ триггеры на messages. Убедитесь, что у вас нет других важных триггеров!

## Если проблема осталась

1. Проверьте, нет ли функций, которые вызываются из других мест (не через триггеры)
2. Проверьте, нет ли триггеров на других таблицах, которые создают уведомления
3. Проверьте логи Supabase на наличие ошибок
