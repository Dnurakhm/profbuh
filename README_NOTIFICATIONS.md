# Группировка уведомлений о сообщениях по проекту

## Что было сделано

Реализована группировка уведомлений о новых сообщениях в чате по одному проекту. Теперь вместо создания нового уведомления для каждого сообщения, система обновляет существующее уведомление, увеличивая счетчик сообщений.

## Как это работает

1. При первом сообщении в проекте создается новое уведомление: "Новое сообщение по проекту"
2. При последующих сообщениях в том же проекте обновляется существующее уведомление:
   - "2 новых сообщения по проекту"
   - "3 новых сообщений по проекту"
   - и т.д.

## Установка

### Шаг 1: Выполнить SQL в Supabase

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в **SQL Editor**
4. Откройте файл `supabase_group_notifications.sql` из корня проекта
5. Скопируйте весь SQL код и выполните его в SQL Editor
6. Убедитесь, что выполнение прошло успешно (должно быть сообщение "Success")

### Шаг 2: Проверить работу

1. Откройте два разных браузера (или вкладки в режиме инкогнито)
2. Войдите под разными пользователями (клиент и бухгалтер)
3. Откройте один и тот же проект
4. Отправьте несколько сообщений от одного пользователя
5. Проверьте уведомления у второго пользователя - должно быть одно уведомление с увеличивающимся счетчиком

## Что изменилось в коде

1. **`supabase_group_notifications.sql`** - SQL функция и триггер для группировки уведомлений
2. **`src/components/notifications.tsx`** - добавлена подписка на UPDATE события
3. **`src/app/notifications/page.tsx`** - добавлена подписка на UPDATE события для обновления списка в реальном времени

## Структура базы данных

После выполнения SQL в таблице `notifications` будут добавлены поля:
- `job_id` (UUID) - ссылка на проект
- `message_count` (INTEGER) - количество сообщений в уведомлении

## Примечания

- Старые уведомления останутся без изменений (можно удалить вручную через Supabase Dashboard)
- Если нужно изменить текст уведомлений, отредактируйте функцию `handle_chat_message_notification()` в SQL Editor
- Уведомления других типов (new_bid, job_accepted) не затрагиваются и работают как раньше
