# Настройка новой системы уведомлений

## Порядок выполнения SQL файлов

Выполните SQL файлы в Supabase SQL Editor **строго в следующем порядке**:

### 1. Очистка старой системы
**Файл:** `supabase_cleanup_old_notifications.sql`
- Удаляет все старые триггеры и функции
- Очищает старую систему уведомлений

### 2. Создание новой системы
**Файл:** `supabase_new_notifications_system.sql`
- Создает новые функции для уведомлений
- Создает триггеры для автоматического создания уведомлений
- Реализует группировку уведомлений

### 3. Настройка RLS политик
**Файл:** `supabase_notifications_rls_new.sql`
- Настраивает права доступа к таблице notifications
- Разрешает триггерам создавать уведомления
- Разрешает пользователям читать и обновлять свои уведомления

## Типы уведомлений

### 1. Уведомления о сообщениях в чате (`chat_message`)
- **Для кого:** Заказчик и Бухгалтер
- **Группировка:** По проекту (job_id)
- **Счетчик:** Показывает количество непрочитанных сообщений (1, 2, 3...)

### 2. Уведомления об откликах (`new_bid`)
- **Для кого:** Заказчик
- **Группировка:** По проекту (job_id)
- **Счетчик:** Показывает количество новых откликов (1, 2, 3...)

### 3. Уведомления о назначении исполнителя (`job_assigned`)
- **Для кого:** Бухгалтер
- **Группировка:** Нет (каждое уведомление отдельно)
- **Счетчик:** Всегда 1

## Как работает группировка

1. При первом событии (сообщение/отклик) создается новое уведомление с `notification_count = 1`
2. При последующих событиях для того же проекта:
   - Ищется непрочитанное уведомление того же типа для этого проекта
   - Если найдено → увеличивается счетчик `notification_count`
   - Если не найдено → создается новое уведомление
3. После прочтения уведомления новые события создадут новое уведомление

## Структура таблицы notifications

- `id` - UUID, первичный ключ
- `user_id` - UUID, получатель уведомления
- `type` - Тип уведомления: `chat_message`, `new_bid`, `job_assigned`
- `title` - Заголовок уведомления
- `content` - Содержание уведомления
- `link` - Ссылка для перехода
- `job_id` - UUID, связь с проектом (для группировки)
- `notification_count` - INTEGER, количество событий (для группировки)
- `is_read` - BOOLEAN, прочитано ли уведомление
- `created_at` - TIMESTAMP, время создания

## Проверка работы

1. **Уведомления о сообщениях:**
   - Отправьте несколько сообщений в чате одного проекта
   - Должно быть одно уведомление с увеличивающимся счетчиком

2. **Уведомления об откликах:**
   - Создайте несколько откликов на один проект
   - У заказчика должно быть одно уведомление с увеличивающимся счетчиком

3. **Уведомления о назначении:**
   - Выберите бухгалтера в качестве исполнителя
   - У бухгалтера должно появиться уведомление

4. **Прочитанные/непрочитанные:**
   - Кликните на уведомление
   - Оно должно стать прочитанным (визуально изменится)

## Если что-то не работает

1. Проверьте, что все 3 SQL файла выполнены в правильном порядке
2. Проверьте консоль браузера на ошибки
3. Проверьте логи Supabase на наличие ошибок в триггерах
4. Убедитесь, что RLS политики созданы правильно
