# Исправление ошибки RLS для уведомлений

## Проблема
При отправке сообщения возникает ошибка:
```
new row violates row-level security policy for table "notifications"
```

## Причина
Триггер пытается создать уведомление в таблице `notifications`, но RLS блокирует вставку, потому что:
1. Функция триггера выполняется в контексте пользователя, который отправил сообщение
2. Но уведомление нужно создать для другого пользователя (получателя)
3. RLS не позволяет пользователю создавать уведомления для других

## Решение

### Шаг 1: Обновить функцию триггера (SECURITY DEFINER)

1. Откройте файл `supabase_group_notifications.sql`
2. Выполните его в Supabase SQL Editor
3. Функция `handle_chat_message_notification()` теперь использует `SECURITY DEFINER`, что позволяет ей обходить RLS

### Шаг 2: Создать политики RLS для notifications

1. Откройте файл `supabase_notifications_rls.sql`
2. Выполните его в Supabase SQL Editor
3. Это создаст политики, которые:
   - Разрешают пользователям читать свои уведомления
   - Разрешают пользователям обновлять свои уведомления
   - Разрешают системе (триггерам) создавать и обновлять уведомления

## Порядок выполнения SQL

**ВАЖНО:** Выполните SQL файлы в следующем порядке:

1. **Сначала:** `supabase_notifications_rls.sql` (создает политики RLS)
2. **Затем:** `supabase_group_notifications.sql` (обновляет функцию триггера с SECURITY DEFINER)

## Что изменилось

### В `supabase_group_notifications.sql`:
```sql
CREATE OR REPLACE FUNCTION handle_chat_message_notification()
RETURNS TRIGGER
SECURITY DEFINER  -- ← Добавлено: функция выполняется с правами создателя
SET search_path = public
AS $$
```

### В `supabase_notifications_rls.sql`:
- Созданы политики для чтения уведомлений пользователями
- Созданы политики для обновления уведомлений пользователями
- Созданы политики для вставки/обновления уведомлений системой (триггерами)

## Проверка работы

1. Выполните оба SQL файла в указанном порядке
2. Перезагрузите страницу с чатом
3. Отправьте сообщение
4. Ошибка должна исчезнуть, и уведомление должно быть создано

## Безопасность

- `SECURITY DEFINER` позволяет функции обходить RLS, но безопасность обеспечивается тем, что:
  - Функция проверяет, что пользователь является участником проекта
  - Функция создает уведомление только для получателя сообщения
  - Пользователи могут читать только свои уведомления

## Если проблема осталась

1. Убедитесь, что оба SQL файла выполнены успешно
2. Проверьте, что функция `handle_chat_message_notification()` имеет `SECURITY DEFINER`
3. Проверьте, что политики RLS созданы на таблице `notifications`
4. Проверьте консоль браузера на другие ошибки
